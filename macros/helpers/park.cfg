[gcode_macro PARK]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
gcode:
    STEP_ASIDE_SON

[gcode_macro STEP_ASIDE_SON]
description: park toolhead 
gcode:
    {% set min = printer.toolhead.axis_minimum %}
    {% set max = printer.toolhead.axis_maximum %}
    {% set act = printer.gcode_move.gcode_position %}

    {% set x_park = (max.x / 2.0) - act.x|round(2) %}
    {% set y_park = (max.y - 0.5) - act.y|round(2) %}
    {% set z_park = [[act.z + 6.66, max.z * 0.62]|max, max.z]|min|round(2) %}

    _BASE_PARK X={x_park} Y={y_park} Z={z_park}

[gcode_macro _BASE_PARK]
description: park toolhead with relative coordinat
gcode:
    {% set velocity_travel = params.TRAVEL|default(printer.configfile.settings.printer.max_velocity)  |int * 60 %}
    {% set velocity_hop    = params.HOP   |default(printer.configfile.settings.printer.max_z_velocity)|int * 60 %}

    {% set x = params.X|default(0)|float %}
    {% set y = params.Y|default(0)|float %}
    {% set z = params.Z|default(0)|float %}

    {% set x_safe = x if x|abs < z|abs else x %}
    {% set y_safe = y if y|abs < z|abs else y %}

    {% if "xyz" not in printer.toolhead.homed_axes %}
        RESPOND TYPE=ERROR MSG="Printer not homed"
    {% else %}
        RETRACT WIPE=1
        SAVE_GCODE_STATE NAME=PARK_STATE
        RELATIVE
        G0 X{x_safe} Y{y_safe} Z{z} F{velocity_hop}
        G1 X{x - x_safe} Y{y - y_safe} F{velocity_travel}
        RESTORE_GCODE_STATE NAME=PARK_STATE MOVE=0
    {% endif %}


    